<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gewicht-Tracker (Firebase)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Gewicht-Tracker</h1>
  <div class="container">
    <!-- Eingaben -->
    <div class="card grid grid-2">
      <div class="person">
        <h3>PP</h3>
        <div class="row">
          <div><label>Heutiges Gewicht (kg)</label><input type="number" step="0.1" id="meWeight" placeholder="kg" /></div>
          <div><label>Zielgewicht (kg)</label><input type="number" step="0.1" id="meGoal" placeholder="kg" /></div>
        </div>
        <button class="btn" id="saveMe">Speichern</button>
      </div>
      <div class="person">
        <h3>JH</h3>
        <div class="row">
          <div><label>Heutiges Gewicht (kg)</label><input type="number" step="0.1" id="colWeight" placeholder="kg" /></div>
          <div><label>Zielgewicht (kg)</label><input type="number" step="0.1" id="colGoal" placeholder="kg" /></div>
        </div>
        <button class="btn" id="saveCol">Speichern</button>
      </div>
    </div>

    <!-- Liniengraph -->
    <div class="card">
      <div class="chart-wrap"><canvas id="lineChart"></canvas></div>
      <div class="legend">
        <span class="dot" style="background:var(--me)"></span> PP
        <span class="dot" style="background:var(--col)"></span> JH
        <span class="dash"></span> Ziel-Linien
      </div>
    </div>

  <!-- Firebase + App Code -->
  <script type="module">
    // ---- Firebase SDK ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      initializeFirestore,
      doc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // >>>> Deine Config hier einsetzen (aus Firebase Console kopieren)
    const firebaseConfig = {
      apiKey: "AIzaSyBSjgdQAnT3Bz9iojou02KIT1Csx-CQ74k",
        authDomain: "weighttracker-35b96.firebaseapp.com",
        projectId: "weighttracker-35b96",
        storageBucket: "weighttracker-35b96.firebasestorage.app",
        messagingSenderId: "676669952179",
        appId: "1:676669952179:web:e0b1747973ecab9b81e0c6",
        measurementId: "G-1EC00GJ8NN"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Firestore mit LongPolling (verhindert Blocker-Fehler)
    const db   = initializeFirestore(app, { experimentalAutoDetectLongPolling: true });

    // Anonym einloggen
    signInAnonymously(auth).catch(console.error);

    // ---- Charts Setup ----
    const lineCtx   = document.getElementById('lineChart').getContext('2d');

    let lineChart;
    const store = { data:{me:{}, col:{}}, goals:{me:75, col:85} };

    function formatDE(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
    function sortedDates(){
      const set = new Set([...Object.keys(store.data.me), ...Object.keys(store.data.col)]);
      return [...set].sort();
    }
    function progressFor(person){
      const rec = store.data[person];
      const dates = Object.keys(rec).sort();
      if(dates.length===0) return { pct:0 };
      const start = rec[dates[0]], now = rec[dates[dates.length-1]], goal = store.goals[person];
      if(goal===start) return { pct:100 };
      const span = Math.abs(goal - start); if(span===0) return { pct:0 };
      const moved = (goal < start) ? (start - now) : (now - start);
      return { pct: Math.max(0, Math.min(100, (moved/span)*100)) };
    }

    function redraw(){
      const dates = sortedDates();
      const labels = dates.map(formatDE);
      const meData = dates.map(d => store.data.me[d] ?? null);
      const colData= dates.map(d => store.data.col[d] ?? null);

      if(lineChart) lineChart.destroy();
      lineChart = new Chart(lineCtx, {
        type:'line',
        data:{ labels, datasets:[
          { label:'PP', data:meData, borderColor:getCSS('--me'), pointBorderColor:getCSS('--me'), pointBackgroundColor:'white', pointRadius:3, borderWidth:2, cubicInterpolationMode:'monotone', tension:.3, spanGaps:true },
          { label:'JH', data:colData, borderColor:getCSS('--col'), pointBorderColor:getCSS('--col'), pointBackgroundColor:'white', pointRadius:3, borderWidth:2, cubicInterpolationMode:'monotone', tension:.3, spanGaps:true },
          { label:'Ziel PP', data:dates.map(()=>store.goals.me), borderColor:getCSS('--me-soft'), borderDash:[6,6], pointRadius:0, borderWidth:2 },
          { label:'Ziel JH', data:dates.map(()=>store.goals.col), borderColor:getCSS('--col-soft'), borderDash:[6,6], pointRadius:0, borderWidth:2 },
        ]},
        options:{ maintainAspectRatio:false, interaction:{intersect:false,mode:'index'},
          plugins:{legend:{display:true}, tooltip:{callbacks:{label:(c)=>`${c.dataset.label}: ${c.parsed.y ?? '-'} kg`}}},
          scales:{ x:{title:{display:true,text:'Datum'}}, y:{title:{display:true,text:'kg'}, ticks:{precision:0} } }
        }
      });
    }

    function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function toISO(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }

    // ---- Firestore Live Updates ----
    onSnapshot(doc(db,'goals','me'), snap => { if(snap.exists()){ store.goals.me = Number(snap.data().goal); document.getElementById('meGoal').value=store.goals.me; redraw(); } });
    onSnapshot(doc(db,'goals','col'), snap => { if(snap.exists()){ store.goals.col = Number(snap.data().goal); document.getElementById('colGoal').value=store.goals.col; redraw(); } });
    onSnapshot(query(collection(db,'weights'), orderBy('date')), (qs)=>{
      store.data.me={}; store.data.col={};
      qs.forEach(docSnap=>{
        const d=docSnap.data(); const date=String(d.date).slice(0,10); const person=d.person;
        if(!date||!person) return;
        if(d.weight!=null&&d.weight!==""){ store.data[person][date]=Number(d.weight); }
      });
      redraw();
    });

    // ---- Speichern ----
    document.getElementById('saveMe').addEventListener('click',()=>save('me'));
    document.getElementById('saveCol').addEventListener('click',()=>save('col'));

    async function save(person){
      const wInput=document.getElementById(person==='me'?'meWeight':'colWeight');
      const gInput=document.getElementById(person==='me'?'meGoal':'colGoal');
      const weight=wInput.value?parseFloat(wInput.value):null;
      const goal=gInput.value?parseFloat(gInput.value):null;
      const date=toISO(new Date());
      const ops=[];
      if(weight!==null&&!Number.isNaN(weight)){
        const id=`${date}_${person}`;
        ops.push(setDoc(doc(db,'weights',id),{date,person,weight,ts:serverTimestamp()},{merge:true}));
        wInput.value='';
      }
      if(goal!==null&&!Number.isNaN(goal)){
        ops.push(setDoc(doc(db,'goals',person),{goal},{merge:true}));
      }
      if(ops.length===0){ alert('Bitte Gewicht oder Ziel eintragen.'); return; }
      await Promise.all(ops);
    }

    // ---- Start ----
    onAuthStateChanged(auth,()=>{ redraw(); });
  </script>
</body>
</html>
